{% load humanize %}

<style type="text/css">
li#nav_dashsecurity>a::after {
    content: '';
    position: absolute;
    left: 0;
    display: inline-block;
    height: 0.4em;
    width: 100%;
    border-bottom: 2px solid #755467;
    margin-top: 15px;
}
</style>	

<div class="gridster">
	<h1 class="dashing-title">Humanitarian Access 
		{% include "links_title.html" %}
		{% include "qlink_span.html" %}	
	</h1> 

</div>

<div class="gridster" style="margin-bottom: 39px;">
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;"> 
	    <i class="fa fa-calendar"></i>&nbsp; Incident between:
	    <span></span> <b class="caret"></b>
	</div>
</div>

<!-- <div class="gridster" style="margin-bottom: 69px; z-index:3001;opacity:1 !important;">
	<div class="pull-left" style="padding-left: 10px;">
		<select class="selectpicker" multiple data-selected-text-format="count" data-actions-box="true" data-selectAllText="All Selected">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>	
	<div class="pull-right">
		<select class="selectpicker" multiple data-actions-box="true">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>	
</div> -->

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
  			<!-- <select multiple="multiple" id="incidentType-select" name="my-select[]">
		      {% for item in main_type_child %}
		      	<option value='{{ item.main_type }}' {% if item.main_type in incident_type %}selected{% endif %}>{{ item.main_type }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select> -->
		    <div class="custom-header">
		    	<div style="float:left;font-size: small;padding: 5px;">select incident type</div> 
		    	<div style="float:right;">
		    		<button type="button" class="btn btn-primary btn-sm type_all">Select All</button>
		    		<button type="button" class="btn btn-primary btn-sm type_none">Select None</button>
		    		<button type="button" class="btn btn-primary btn-sm apply">Apply</button>
		    	</div>
		    </div>
	    	{% for item in main_type_child %}
	                <div class="checkbox checkbox-inline">
	                    <input id="type{{ forloop.counter0 }}" name="main_type_select[]" class="styled" type="checkbox" value="{{ item.main_type }}"  {% if item.main_type in incident_type %}checked=true{% endif %}>
	                    <label for="type{{ forloop.counter0 }}">
	                        {{ item.main_type }} ({{item.count}} incidents)
	                    </label>
	                </div>
            {% endfor %}    
            
		</li>
  		<!-- <li data-row="1" data-col="1" data-sizex="2" data-sizey="2">
			<div>{{ casualties_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li> -->
		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
			<!-- <select multiple="multiple" id="incidentTarget-select" name="my-select[]">
		      {% for item in main_target_child %}
		      	<option value='{{ item.main_target }}' {% if item.main_target in incident_target %}selected{% endif %}>{{ item.main_target }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select> -->
		    <div class="custom-header">
		    	<div style="float:left;font-size: small;padding: 5px;">select incident target</div> 
		    	<div style="float:right;">
		    		<button type="button" class="btn btn-primary btn-sm target_all">Select All</button>
		    		<button type="button" class="btn btn-primary btn-sm target_none">Select None</button>
		    		<button type="button" class="btn btn-primary btn-sm apply">Apply</button>
		    	</div>
		    </div>
	    	{% for item in main_target_child %}
	                <div class="checkbox checkbox-inline">
	                    <input id="target{{ forloop.counter0 }}" name="main_target_select[]" class="styled" type="checkbox" value="{{ item.main_target }}"  {% if item.main_target in incident_target %}checked=true{% endif %}>
	                    <label for="target{{ forloop.counter0 }}">
	                        {{ item.main_target }} ({{item.count}} incidents)
	                    </label>
	                </div>
            {% endfor %}  
		</li>

  	</ul>
</div>

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div>{{ main_type_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li>
  		<!-- <li data-row="1" data-col="1" data-sizex="2" data-sizey="2">
			<div>{{ casualties_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li> -->
		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div>{{ main_target_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li>

  	</ul>
</div>


<div  class="gridster">
	<table>
		<thead>
			<tr class='dataitem'>
				<td colspan=3 style="text-align:left;padding:3px;font-weight:bolder;">Number of incidents and casualties</td>
				<td colspan=2 style="text-align:right;padding:3px;"><div class='showFlag_base' onClick='show_hide_base()'>{% if "detail_base" in checked %}Hide Detail{% else %}Show Detail{% endif %}</div></td>
			</tr>
			<tr>
				<th rowspan=2><span>Region</span></th>
				<th rowspan=2><span># Incidents</span></th>
				<th colspan=3>Casualties</th>
				<!-- <th rowspan=2><span>Health Facilities</span></th>
				<th rowspan=2><span>Length of Roads</span></th> -->
			</tr>
			<tr>
				<th><span>Dead</span></th>
				<th><span>Injured</span></th>
				<th><span>Violent</span></th>
			</tr>
		</thead>
		<tbody>
			<tr class='dataitem'>
				<td class="parent_list">{{parent_label}}</td>
				<td class="parent_value">{{total_incident | intword | intcomma}}</td>
				<td class="parent_value">{{total_dead | intword | intcomma}}</td>
				<td class="parent_value">{{total_injured | intword | intcomma}}</td>
				<td class="parent_value">{{total_violent | intword | intcomma}}</td>
			</tr>
			{% for data in lc_child %}
			<tr class='dataitem detail_base {% if "detail_base" not in checked %} hide {% endif %}' onclick="jump_url({{data.code}});">
				<td class="detail_list">{{data.na_en}}</td>
				<td class="detail_value">{{data.total_incident | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_dead | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_injured | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_violent | intword | intcomma}}</td>		
			</tr>
			{% endfor %}
			<tr>
				<td class="separator" colspan=10></td>	
			</tr>
		</tbody>
	</table>
</div>

<div class="gridster">
	<div class="col-md-4 col-cust-4" style="padding-left:0px !important;">
		<div class="table_scroll">
			<table style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=5 style="text-align:left;padding:3px;font-weight:bolder;">Incident Type</th>
					</tr>
					<tr>
						<th></th>
						<th>Incidents</th>
						<th>Dead</th>
						<th>Injured</th>
						<th>Violent</th>
					</tr>	
				</thead>
				<tbody>
					{% for data in incident_type_group %}
						<tr style="background: #eee;">
							<td style="text-align:left;">{{ data.main_type }}</td>
							<td style="text-align:right;">{{ data.count }}</td>
							<td style="text-align:right;">{{ data.dead }}</td>
							<td style="text-align:right;">{{ data.injured }}</td>
							<td style="text-align:right;">{{ data.violent }}</td>
						</tr>
						{% for item in data.child %}
							<tr>
								<td style="text-align:left;word-wrap: break-word;max-width:100px;">{{ item.type }}</td>
								<td style="text-align:right;">{{ item.count }}</td>
								<td style="text-align:right;">{{ item.dead }}</td>
								<td style="text-align:right;">{{ item.injured }}</td>
								<td style="text-align:right;">{{ item.violent }}</td>
							</tr>
						{% endfor %}
					{% endfor %}
				</tbody>	
			</table>
		</div>
	</div>	
	<div class="col-md-4 col-cust-4">
		<div class="table_scroll">
			<table style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=5 style="text-align:left;padding:3px;font-weight:bolder;">Incident Target</th>
					</tr>
					<tr>
						<th></th>
						<th>Incidents</th>
						<th>Dead</th>
						<th>Injured</th>
						<th>Violent</th>
					</tr>	
				</thead>
				<tbody>
					{% for data in incident_target_group %}
						<tr style="background: #eee;">
							<td style="text-align:left;">{{ data.main_target }}</td>
							<td style="text-align:right;">{{ data.count }}</td>
							<td style="text-align:right;">{{ data.dead }}</td>
							<td style="text-align:right;">{{ data.injured }}</td>
							<td style="text-align:right;">{{ data.violent }}</td>
						</tr>
						{% for item in data.child %}
							<tr>
								<td style="text-align:left;word-wrap: break-word;max-width:100px;">{{ item.target }}</td>
								<td style="text-align:right;">{{ item.count }}</td>
								<td style="text-align:right;">{{ item.dead }}</td>
								<td style="text-align:right;">{{ item.injured }}</td>
								<td style="text-align:right;">{{ item.violent }}</td>
							</tr>
						{% endfor %}
					{% endfor %}
				</tbody>		
			</table>
		</div>	
	</div>
	<div class="col-md-4 col-cust-4" style="padding-right:0px !important;">
		<div class="table_scroll">
			<table style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=2 style="text-align:left;padding:3px;font-weight:bolder;">Latest Incidents</th>
					</tr>
					<tr>
						<th>Date</th>
						<th>Description</th>
					</tr>	
				</thead>	
				<tbody>
				{% for item in incident_list_100 %}
					<tr>
						<td style="text-align:left;width: 100px;">{{ item.incident_date }}</td>
						<td style="text-align:left;">{{ item.description }}</td>
					</tr>
				{% endfor %}	
				</tbody>
			</table>
		</div>	
	</div>
</div>	




<SCRIPT TYPE="text/javascript">

function show_hide_base(){
	if ($("div.showFlag_base").text() == "Show Detail") {
		$("div.showFlag_base").text('Hide Detail');
		_checked.push('detail_base');
	} else {
		$("div.showFlag_base").text('Show Detail');
		removeA(_checked, 'detail_base');
	}
	$( ".detail_base" ).toggleClass(function(){
		if ( $( this ).parent().is( ".hide" ) ) {
		    return "show";		    
		} else {
			// $("div.showFlag").text("<p>Show Detail</p>");
		    return "hide";	    
		}
	});
}
	
document.addEventListener('DOMContentLoaded', function() {
	var daterange = getParameterByName("daterange");
    if (daterange == null){
      var start = moment().subtract(365, 'days');
      var end = moment();
    } else {
      var dateVar = daterange.split(',');
      var start = moment(new Date(dateVar[0].substr(0, 4), parseInt(dateVar[0].substr(5, 2))-1, dateVar[0].substr(8, 2)));
      var end = moment(new Date(dateVar[1].substr(0, 4), parseInt(dateVar[1].substr(5, 2))-1, dateVar[1].substr(8, 2)));;
    }  

    

    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
           'Last Year': [moment().subtract(365, 'days'), moment()]
        }
    }, cb);

    cb(start, end);

    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
        var url = $(location).attr("href");
        if (daterange == null){
          window.document.location = url+'&daterange='+picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD');
        }  else {
          // url = url.replace(/(daterange=).*?(&)/,'$1' + picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD') + '$2');
          url = updateUrlParameter(url, 'daterange', picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD'))

          window.document.location = url;
        }
    });

    $('#incidentType-select').multiSelect({
      selectableHeader: "<div class='custom-header'>Unselected Incident Type <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>Selected Incident Type <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>"
    });

    $('#incidentTarget-select').multiSelect({
      selectableHeader: "<div class='custom-header'>Unselected Incident Target <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>Selected Incident Target <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>"
    });


	$('button.apply').on('click', function(event) {
		var type_selected_param = '';
		var target_selected_param = '';

		// var type_unselected = $('#ms-incidentType-select').find('.ms-elem-selectable:not(.ms-selected)');
		// var type_selected = $('#ms-incidentType-select').find('.ms-elem-selectable.ms-selected');

		var type_unselected = $("input[name='main_type_select[]']:checkbox:not(:checked)");
		var type_selected = $("input[name='main_type_select[]']:checkbox:checked");

		// var target_unselected = $('#ms-incidentTarget-select').find('.ms-elem-selectable:not(.ms-selected)');
		// var target_selected = $('#ms-incidentTarget-select').find('.ms-elem-selectable.ms-selected');

		var target_unselected = $("input[name='main_target_select[]']:checkbox:not(:checked)");
		var target_selected = $("input[name='main_target_select[]']:checkbox:checked");

		if (type_unselected.length > 0) {
			// var type_array = type_selected.val();
			var type_array = [];
			type_selected.each( function () {
			   type_array.push($(this).val());
			});
			type_selected_param += type_array;
		}


		if (target_unselected.length > 0) {
			// var target_array = $('#incidentTarget-select').val();
			var target_array = [];
			target_selected.each( function () {
			   target_array.push($(this).val());
			});
			target_selected_param += target_array
		}

		if (type_selected.length == 0) {
			type_selected_param = 'noselection';
		}

		if (target_selected.length == 0) {
			target_selected_param = 'noselection';
		}

		var url = $(location).attr("href");
		
		if (type_selected_param != ''){
			if (getParameterByName("incident_type") == null){
				url += '&incident_type='+type_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_type', type_selected_param);
			}
			
		} else {
			url = removeParam('incident_type', url);
		}

		if (target_selected_param != ''){
			if (getParameterByName("incident_target") == null){
				url += '&incident_target='+target_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_target', target_selected_param)
			}
			
		} else {
			url = removeParam('incident_target', url);
		}

		window.document.location = url;

	});

	$('button.type_all').on('click', function(event) {
		$("input[name='main_type_select[]']:checkbox").prop('checked', true);
	});

	$('button.type_none').on('click', function(event) {
		$("input[name='main_type_select[]']:checkbox").prop('checked', false);
	});

	$('button.target_all').on('click', function(event) {
		$("input[name='main_target_select[]']:checkbox").prop('checked', true);
	});

	$('button.target_none').on('click', function(event) {
		$("input[name='main_target_select[]']:checkbox").prop('checked', false);
	});
});

</SCRIPT>
