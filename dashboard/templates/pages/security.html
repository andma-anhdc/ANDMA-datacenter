{% load humanize %}

<style type="text/css">
li#nav_dashsecurity>a::after {
    content: '';
    position: absolute;
    left: 0;
    display: inline-block;
    height: 0.4em;
    width: 100%;
    border-bottom: 2px solid #755467;
    margin-top: 15px;
}
</style>


	

<div class="gridster">
	<h1 class="dashing-title">Humanitarian Access {% for label in parent_label_dash %} - <a class="label_link" href="#" onclick='jump_url({{ label.code }});'>{{ label.name }}</a> {% endfor %}</h1>
</div>

<div class="gridster" style="margin-bottom: 39px;">
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;"> 
	    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp; Incident between:
	    <span></span> <b class="caret"></b>
	</div>
</div>

<!-- <div class="gridster" style="margin-bottom: 69px; z-index:3001;opacity:1 !important;">
	<div class="pull-left" style="padding-left: 10px;">
		<select class="selectpicker" multiple data-selected-text-format="count" data-actions-box="true" data-selectAllText="All Selected">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>	
	<div class="pull-right">
		<select class="selectpicker" multiple data-actions-box="true">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>	
</div> -->

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
  			<select multiple="multiple" id="incidentType-select" name="my-select[]">
		      {% for item in main_type_child %}
		      	<option value='{{ item.main_type }}' {% if item.main_type in incident_type %}selected{% endif %}>{{ item.main_type }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select>
		</li>
  		<!-- <li data-row="1" data-col="1" data-sizex="2" data-sizey="2">
			<div>{{ casualties_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li> -->
		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
			<select multiple="multiple" id="incidentTarget-select" name="my-select[]">
		      {% for item in main_target_child %}
		      	<option value='{{ item.main_target }}' {% if item.main_target in incident_target %}selected{% endif %}>{{ item.main_target }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select>
		</li>

  	</ul>
</div>

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div>{{ main_type_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li>
  		<!-- <li data-row="1" data-col="1" data-sizex="2" data-sizey="2">
			<div>{{ casualties_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li> -->
		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div>{{ main_target_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li>

  	</ul>
</div>


<div  class="gridster">
	<table>
		<thead>
			<tr class='dataitem'>
				<td colspan=3 style="text-align:left;padding:3px;font-weight:bolder;">Population and area overview</td>
				<td colspan=2 style="text-align:right;padding:3px;"><div class='showFlag_base' onClick='show_hide_base()'>Show Detail</div></td>
			</tr>
			<tr>
				<th rowspan=2><span>Region</span></th>
				<th rowspan=2><span># Incidents</span></th>
				<th colspan=3>Casualties</th>
				<!-- <th rowspan=2><span>Health Facilities</span></th>
				<th rowspan=2><span>Length of Roads</span></th> -->
			</tr>
			<tr>
				<th><span>Dead</span></th>
				<th><span>Injured</span></th>
				<th><span>Violent</span></th>
			</tr>
		</thead>
		<tbody>
			<tr class='dataitem'>
				<td class="parent_list">{{parent_label}}</td>
				<td class="parent_value">{{total_incident | intword | intcomma}}</td>
				<td class="parent_value">{{total_dead | intword | intcomma}}</td>
				<td class="parent_value">{{total_injured | intword | intcomma}}</td>
				<td class="parent_value">{{total_violent | intword | intcomma}}</td>
			</tr>
			{% for data in lc_child %}
			<tr class='dataitem detail_base hide' onclick="jump_url({{data.code}});">
				<td class="detail_list">{{data.na_en}}</td>
				<td class="detail_value">{{data.total_incident | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_dead | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_injured | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_violent | intword | intcomma}}</td>		
			</tr>
			{% endfor %}
			<tr>
				<td class="separator" colspan=10></td>	
			</tr>
		</tbody>
	</table>
</div>


<SCRIPT TYPE="text/javascript">

function jump_url(code){
	var url = window.location.href;

	if (getParameterByName("code") == null){
		url += '&code='+code;
	} else {
		url = updateUrlParameter(url, 'code', code)
	}

	if (code == 0){
		url = removeParam('code', url)
	}

	window.document.location = url;

}

function show_hide_base(){
	if ($("div.showFlag_base").text() == "Show Detail") {
		$("div.showFlag_base").text('Hide Detail');
	} else {
		$("div.showFlag_base").text('Show Detail');
	}
	$( ".detail_base" ).toggleClass(function(){
		if ( $( this ).parent().is( ".hide" ) ) {
		    return "show";		    
		} else {
			// $("div.showFlag").text("<p>Show Detail</p>");
		    return "hide";	    
		}
	});
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function updateUrlParameter(url, param, value){
    var regex = new RegExp('([?|&]'+param+'=)[^\&]+');
    return url.replace( regex , '$1' + value);
}

function removeParam(key, sourceURL) {
    var rtn = sourceURL.split("?")[0],
        param,
        params_arr = [],
        queryString = (sourceURL.indexOf("?") !== -1) ? sourceURL.split("?")[1] : "";
    if (queryString !== "") {
        params_arr = queryString.split("&");
        for (var i = params_arr.length - 1; i >= 0; i -= 1) {
            param = params_arr[i].split("=")[0];
            if (param === key) {
                params_arr.splice(i, 1);
            }
        }
        rtn = rtn + "?" + params_arr.join("&");
    }
    return rtn;
}

	
document.addEventListener('DOMContentLoaded', function() {
	var daterange = getParameterByName("daterange");
    if (daterange == null){
      var start = moment().subtract(365, 'days');
      var end = moment();
    } else {
      var dateVar = daterange.split(',');
      var start = moment(new Date(dateVar[0].substr(0, 4), parseInt(dateVar[0].substr(5, 2))-1, dateVar[0].substr(8, 2)));
      var end = moment(new Date(dateVar[1].substr(0, 4), parseInt(dateVar[1].substr(5, 2))-1, dateVar[1].substr(8, 2)));;
    }  

    

    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
           'Last Year': [moment().subtract(365, 'days'), moment()]
        }
    }, cb);

    cb(start, end);

    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
        var url = $(location).attr("href");
        if (daterange == null){
          window.document.location = url+'&daterange='+picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD');
        }  else {
          // url = url.replace(/(daterange=).*?(&)/,'$1' + picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD') + '$2');
          url = updateUrlParameter(url, 'daterange', picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD'))

          window.document.location = url;
        }
    });

    $('#incidentType-select').multiSelect({
      selectableHeader: "<div class='custom-header'>Unselected Incident Type <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>Selected Incident Type <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>"
    });

    $('#incidentTarget-select').multiSelect({
      selectableHeader: "<div class='custom-header'>Unselected Incident Target <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>Selected Incident Target <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>"
    });


	$('button.apply').on('click', function(event) {
		var type_selected_param = '';
		var target_selected_param = '';

		var type_unselected = $('#ms-incidentType-select').find('.ms-elem-selectable:not(.ms-selected)');
		var type_selected = $('#ms-incidentType-select').find('.ms-elem-selectable.ms-selected');

		var target_unselected = $('#ms-incidentTarget-select').find('.ms-elem-selectable:not(.ms-selected)');
		var target_selected = $('#ms-incidentTarget-select').find('.ms-elem-selectable.ms-selected');

		if (type_unselected.length > 0) {
			var type_array = $('#incidentType-select').val();
			type_selected_param += type_array;
		}
		if (target_unselected.length > 0) {
			var target_array = $('#incidentTarget-select').val();
			target_selected_param += target_array
		}

		console.log(type_selected_param,target_selected_param);
		var url = $(location).attr("href");
		
		if (type_selected_param != ''){
			if (getParameterByName("incident_type") == null){
				url += '&incident_type='+type_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_type', type_selected_param);
			}
			
		}

		if (target_selected_param != ''){
			if (getParameterByName("incident_target") == null){
				url += '&incident_target='+target_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_target', target_selected_param)
			}
			
		}

		window.document.location = url;

	});
});

</SCRIPT>
